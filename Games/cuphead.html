<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cuphead</title>
<style>
  html, body {
    margin:0; padding:0; height:100%; overflow:hidden; background:#231F20; color:#fff; font-family:Arial,sans-serif;
  }
  #unity-container { position:fixed; inset:0; background:#231F20; }
  #loading-text { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2rem; text-align:center; }
</style>
</head>
<body>

<header style="position:fixed; top:10px; left:10px; z-index:1000;">
  <a id="backLink" href="#">â—€ Back</a>
</header>

<div id="unity-container"></div>
<div id="loading-text">LOADING...</div>

<script>
// ---- Set back link dynamically ----
const back = document.getElementById('backLink');
back.href = window.location.origin + '/index.html';

// ---- CDN paths for all Unity files ----
const CDN_BASE = "https://cdn.jsdelivr.net/gh/web-ports/cuphead@0a443a6e79ff762010b31d771086d17280f9db42/";

const getParts = (filename, start, end) => {
  let arr = [];
  for (let i=start; i<=end; i++) {
    arr.push(CDN_BASE + filename + ".part" + i);
  }
  return arr;
}

const dataParts = getParts("Build/Build.data.unityweb", 1, 103);  // adjust total parts
const asmParts  = getParts("Build/Build.asm.code.unityweb", 1, 3);
const wasmParts = getParts("Build/Build.wasm.code.unityweb", 1, 2);

// ---- Fetch and merge files ----
async function fetchWithProgress(url) {
  const resp = await fetch(url);
  if (!resp.ok) throw new Error("Failed to fetch: " + url);
  const reader = resp.body.getReader();
  let chunks = [], received=0;
  while(true) {
    const {done, value} = await reader.read();
    if(done) break;
    chunks.push(value);
    received += value.length;
    const mb = (received/1024/1024).toFixed(2);
    document.getElementById('loading-text').innerText = `LOADING... ${mb} MB`;
  }
  let totalLength = chunks.reduce((sum, c) => sum + c.length, 0);
  let merged = new Uint8Array(totalLength);
  let offset=0;
  for (let chunk of chunks) {
    merged.set(chunk, offset);
    offset += chunk.length;
  }
  return merged.buffer;
}

async function mergeFiles(parts) {
  const buffers = await Promise.all(parts.map(fetchWithProgress));
  return URL.createObjectURL(new Blob(buffers));
}

// ---- Load Unity ----
(async () => {
  try {
    const [dataUrl, asmUrl, wasmUrl] = await Promise.all([
      mergeFiles(dataParts),
      mergeFiles(asmParts),
      mergeFiles(wasmParts)
    ]);

    const unityConfig = {
      dataUrl,
      frameworkUrl: wasmUrl,      // Unity 2021+ uses wasm + framework combined
      codeUrl: asmUrl,
      streamingAssetsUrl: "StreamingAssets",
      companyName: "SpanishFreddy",
      productName: "Cuphead",
      productVersion: "1.0",
      backgroundColor: "#231F20",
      showBanner: (msg,type) => console.log(msg,type)
    };

    // Load UnityLoader dynamically
    const loaderScript = document.createElement("script");
    loaderScript.src = CDN_BASE + "Build/UnityLoader.js";
    loaderScript.onload = () => {
      createUnityInstance(document.getElementById("unity-container"), unityConfig, (progress) => {
        const percent = (progress*100).toFixed(1);
        document.getElementById('loading-text').innerText = `LOADING... ${percent}%`;
      }).then(() => {
        document.getElementById('loading-text').remove();
      }).catch(console.error);
    };
    document.body.appendChild(loaderScript);
  } catch(err) {
    document.getElementById('loading-text').innerText = "Failed to load game. Check console.";
    console.error(err);
  }
})();
</script>

</body>
</html>
