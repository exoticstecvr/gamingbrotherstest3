<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cuphead</title>
<style>
:root{
  --bg:#07131a;
  --panel:#0b1220;
  --accent:#ffd369;
  --muted:#9aa6b2;
}
html,body{
  height:100%;
  margin:0;
  background:linear-gradient(180deg,#03121a,#071623);
  color:#fff;
  font-family:Inter,Segoe UI,Arial,sans-serif;
}
.wrap{
  max-width:1200px;
  margin:18px auto;
  padding:8px;
}
header{
  display:flex;
  align-items:center;
  gap:12px;
}
header a{
  color:var(--muted);
  text-decoration:none;
}
.player-frame{
  background:#000;
  border-radius:12px;
  padding:12px;
  border:4px solid rgba(255,255,255,0.06);
}
.view{
  position:relative;
  height:70vh;
  border-radius:8px;
  overflow:hidden;
  background:#000;
}
.view iframe{
  width:100%;
  height:100%;
  border:0;
}
.controls{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  display:flex;
  gap:18px;
  background:rgba(3,6,10,0.9);
  padding:12px;
  border-radius:12px;
  border:2px solid rgba(255,255,255,0.06);
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
  z-index:999;
}
.btn{
  background:#0b1220;
  color:var(--accent);
  padding:12px 14px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.03);
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
}
@media (max-width:700px){
  .view{height:56vh}
  .controls{left:8%;transform:none}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <a id="backLink" href="../index.html">â—€ Back</a>
    <h2 style="margin:0;color:var(--accent);padding-left:8px">Cuphead</h2>
  </header>

  <div class="player-frame">
    <div class="view" id="unityContainerWrap">
      <div id="loading-text" style="color:white;font-size:48px;font-family:cursive;text-align:center;margin-top:20px">
        LOADING...
      </div>
      <div id="unityContainer"></div>
    </div>
  </div>

  <div class="controls">
    <!-- Optional buttons -->
  </div>
</div>

<script>
// --- CDN Setup ---
const CDN_BASE = "https://cdn.jsdelivr.net/gh/web-ports/cuphead@0a443a6e79ff762010b31d771086d17280f9db42/";
const cdn = (path) => CDN_BASE + path;

// --- Helper functions ---
function getParts(file, start, end){
  const parts = [];
  for(let i=start;i<=end;i++){
    parts.push(cdn(file+".part"+i));
  }
  return parts;
}

async function fetchWithProgress(url){
  const response = await fetch(url);
  if(!response.ok) throw new Error("Failed to fetch "+url);
  const reader = response.body.getReader();
  let chunks = [];
  let received = 0;
  while(true){
    const {done,value} = await reader.read();
    if(done) break;
    received += value.length;
    chunks.push(value);
  }
  let buffer = new Uint8Array(received);
  let offset = 0;
  for(let chunk of chunks){
    buffer.set(chunk, offset);
    offset += chunk.length;
  }
  return buffer.buffer;
}

async function mergeFiles(parts){
  const buffers = await Promise.all(parts.map(fetchWithProgress));
  return URL.createObjectURL(new Blob(buffers));
}

function resizeUnityContainer(){
  const container = document.getElementById("unityContainer");
  if(container.querySelector("canvas")){
    const canvas = container.querySelector("canvas");
    canvas.style.width = window.innerWidth+"px";
    canvas.style.height = window.innerHeight+"px";
  }
  container.style.width = window.innerWidth+"px";
  container.style.height = window.innerHeight+"px";
}

// --- Load Unity files ---
(async()=>{
  try{
    const asmParts = getParts("Build/Build.asm.code.unityweb",1,3);
    const dataParts = getParts("Build/Build.data.unityweb",1,103);
    const wasmParts = getParts("Build/Build.wasm.code.unityweb",1,2);

    const [asmUrl,dataUrl,wasmUrl] = await Promise.all([
      mergeFiles(asmParts),
      mergeFiles(dataParts),
      mergeFiles(wasmParts)
    ]);

    const unityConfig = {
      companyName:"SpanishFreddy",
      productName:"Cuphead",
      dataUrl:dataUrl,
      wasmCodeUrl:wasmUrl,
      wasmFrameworkUrl:cdn("Build.wasm.framework.unityweb"),
      asmCodeUrl:asmUrl,
      asmMemoryUrl:cdn("Build.asm.memory.unityweb"),
      asmFrameworkUrl:cdn("Build.asm.framework.unityweb"),
      TOTAL_MEMORY:2130706432,
      graphicsAPI:["WebGL 2.0","WebGL 1.0"],
      webglContextAttributes:{preserveDrawingBuffer:false},
      splashScreenStyle:"Dark",
      backgroundColor:"#0b1220"
    };

    window.addEventListener("resize", resizeUnityContainer);

    const loaderScript = document.createElement("script");
    loaderScript.src = cdn("Build/UnityLoader.js");
    loaderScript.onload = ()=>{
      UnityLoader.instantiate("unityContainer", unityConfig, {
        Module:{onRuntimeInitialized:()=>{resizeUnityContainer(); document.getElementById("loading-text").remove();}}
      });
    };
    document.body.appendChild(loaderScript);

  }catch(e){
    console.error("Failed to load Unity files:",e);
    document.getElementById("loading-text").innerText = "Failed to load game files!";
  }
})();
</script>
</body>
</html>
